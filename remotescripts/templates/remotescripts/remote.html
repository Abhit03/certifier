{% extends 'dqmhelper/base.html' %}
{% block title %}Remote script{% endblock %}

{% load static %}

{% block style %}
{% endblock %}

{% block content %}
<div class="container-md container-fluid">
        <div class="row">
            <div class="mt-4 mb-4 col-lg-12 text-center">
				<h1>{{ remote_script }}</h1>
            </div>
        </div>
	
	<ul class="list-group">
		<li class="list-group-item">Host: {{ remote_script.host }}</li>
		<li class="list-group-item">Command: {{ remote_script.base_command }}</li>			
	</ul>

    <div class="container mb-4">
        <div class="card border-light shadow p-3 bg-white rounded mb-4">
            <form
				method="post"
				class="justify-content-center align-items-center"
				id="remote_script_execution_form" >
				{% csrf_token %}
				{{ form }}
				<input type="submit" value="Submit">
			</form>
        </div>
    </div>

	<div class="container overflow-auto">
        <div class="card border-light shadow p-2 bg-dark rounded">
            <button class="btn btn-primary" onClick="clearOutput()" style="position:absolute;top:16px;right:30px;" >Clear</button>
            <textarea class="text-light bg-dark" style="border: none; height: 450px" cols="150" id="id_command_output"></textarea>
        </div>
	</div>
</div>
{% endblock %}

{% block scripts %}
	<script>
	 $(document).ready(function() {	 
		 // WS initialization
		 if (location.protocol === 'https:') {
			 // page is secure
			 var command_output_socket = new WebSocket(
				 'wss://' + window.location.host +
				 '/ws/output/');
		 }
		 else{
			 var command_output_socket = new WebSocket(
				 'ws://' + window.location.host +
				 '/ws/output/');
		 }

		 // Clear output button callback
		 function clearOutput(){
			 $('#id_command_output').val("");
		 }

		 // Callback run on every new message that
		 // is received from the WS
		 command_output_socket.onmessage = function(e) {
			 var data = JSON.parse(e.data);
			 var message = data['message'];
			 document.querySelector('#id_command_output').value += (message);
			 document.getElementById('id_command_output').scrollTop = document.getElementById('id_command_output').scrollHeight;
		 };

		 command_output_socket.onclose = function(e) {
			 console.error('Socket closed unexpectedly: '+ e.message);
		 };
	 })

	 var $myForm = $("#remote_script_execution_form");
	 $myForm.submit(function(){
		 $("#remote_script_execution_form").find(':input[type=submit]').prop('disabled', true);
		 // add spinner to button
		 // if ($('[id=id_run_number]').val() != '') {
		 // 			 $('#id_run_number_list').removeAttr('required');
		 // 		 }
		 // if ($("#id_form_generate_maps")[0].checkValidity()) {
		 // 			 $("#id_generate_maps").html(
		 // 				 `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...`
		 // 			 );
		 // 		 }
		 var $inputs = $('#remote_script_execution_form :input');
		 var values = {};
		 $inputs.each(function() {
			 if(this.name !== ""){
				 values[this.name] = $(this).val();
			 }
		 });
		 $.ajax({
			 headers: { "X-CSRFToken": '{{csrf_token}}' },
			 type: "POST",
			 // url: "",// Not needed
			 data: values,
		 })
		  .always(function(){
		  })
p		  .fail(function(data){
			  let msg = `Command failed with error ${data.status}: ${JSON.parse(data.responseText).message}`;
			  console.error(msg);
			  alert(msg);
		  });
		 return false
	 });
	 
	</script>
{% endblock %}
